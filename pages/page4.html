<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>SDF to Scratch Sprite</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <h2>SDFデータを入力</h2>
  <textarea id="sdfInput" rows="10" cols="60" placeholder="[A]:001,002,.../[B]:.../...;"></textarea><br>
  <button id="generateBtn">sprite3を生成してDL</button>

  <script>
    const listIdMap = {
      A: "wrjicyhmuu[z,K{Ac*?7",
      B: "M~E+sSuFf0S^h!#u)uRO",
      C: ")J#bVgJXl+lus%%sY,N1",
      D: "GgA5?^h0@^_@0_72Zvsx",
      E: "qZKwKaO2Feywh43^p}Ls",
      F: "1Cz-*ryy;gF^5]ZAanfS",
      G: "?LQ0TxT|[cBZsm).|7qR",
      H: "+_.2N~a]F;E@D3Ri)*Hs",
      I: "zu!d#cLmu:p)rtvifjBA",
      J: "ct*M#U-GfnqrR6i-mA]D",
      K: "/rJ=`R,!v!=GoUmHkS^l",
      L: "N-n]=sxgVM:M;zuCe:5b",
      M: "Cq(Soa:;8`3N+F~ZCZ.d",
      N: "(1A6Qj7bJFq!tuAQ3Jqv",
      O: "Cb.YPA0Y/?q:@|W}^WT!",
      P: "]eRbhH$O@:G8-DAhSx%X",
      Q: "IygaQ}!z3FI_NN%Xs,RX",
      R: ".MR#i{o(C8cW61jupx2,",
      S: "DaQ(?yN~oH}].{;f(KTw"
    };

    function parseSDF(text) {
      const result = {};
      text.split("/").forEach(entry => {
        const match = entry.match(/\[([A-S])\]:(.+)/);
        if (match) {
          const key = match[1];
          const values = match[2].split(",").map(x => x.trim().padStart(3, "0"));
          result[key] = values;
        }
      });
      return result;
    }

    document.getElementById("generateBtn").onclick = async () => {
      const sdfText = document.getElementById("sdfInput").value;
      const sdfData = parseSDF(sdfText);

      const response = await fetch("https://raw.githubusercontent.com/ex/ex/.sprite3/new");
      const blob = await response.blob();

      const zip = await JSZip.loadAsync(blob);
      const spriteJson = JSON.parse(await zip.file("sprite.json").async("string"));

      for (const key in sdfData) {
        const id = listIdMap[key];
        if (spriteJson.lists && id in spriteJson.lists) {
          spriteJson.lists[id][1] = sdfData[key]; // データ上書き
        }
      }

      zip.file("sprite.json", JSON.stringify(spriteJson, null, 2));
      const newBlob = await zip.generateAsync({ type: "blob" });

      const a = document.createElement("a");
      a.href = URL.createObjectURL(newBlob);
      a.download = "sdf_output.sprite3";
      a.click();
    };
  </script>
</body>
</html>
