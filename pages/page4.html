<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SDF Visualize & Export to Scratch Sprite</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body {
      background: black;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
    }
    canvas {
      background: black;
    }
    textarea {
      width: 90%;
      height: 100px;
      margin-top: 10px;
    }
    button {
      margin: 5px;
      padding: 8px 16px;
    }
  </style>
</head>
<body>
  <h2>ğŸµ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦SDFç”Ÿæˆ</h2>
  <input type="file" id="audioFile" accept="audio/*" />
  <label>ãƒãƒ¼ã®æ•°: <input type="number" id="barCount" min="1" max="62" value="62" /></label>
  <canvas id="canvas"></canvas>

  <h3>ğŸ“‹ SDFå‡ºåŠ›ï¼ˆç·¨é›†å¯èƒ½ï¼‰</h3>
  <textarea id="sdfTextArea" placeholder="[A]:000,001,002/...;"></textarea><br>
  <button id="exportSpriteBtn">sprite3ã‚’ç”Ÿæˆã—ã¦DL</button>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = 300;

    const getLabel = () => {
      return [..."0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"];
    };

    let audioContext, analyser, dataArray, collectedData = [], animationId, captureInterval;

    document.getElementById("audioFile").addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const audio = new Audio(e.target.result);
        audio.addEventListener('ended', () => {
          clearInterval(captureInterval);
          cancelAnimationFrame(animationId);
        });
        audio.loop = false;
        audio.play();
        setupAudioContext(audio);
      };
      reader.readAsDataURL(file);
    });

    function setupAudioContext(audio) {
      const barCount = Math.min(62, parseInt(document.getElementById("barCount").value));
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      const source = audioContext.createMediaElementSource(audio);
      source.connect(analyser);
      analyser.connect(audioContext.destination);
      analyser.fftSize = 2048;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      collectedData = [];

      captureInterval = setInterval(() => {
        analyser.getByteFrequencyData(dataArray);
        const frame = Array.from(dataArray);
        collectedData.push(extractBars(frame, barCount));
        updateSDFText(barCount);
      }, 50);

      drawBars(barCount);
    }

    function extractBars(frame, barCount) {
      const binPerBar = Math.floor(frame.length / barCount);
      const bars = [];
      for (let i = 0; i < barCount; i++) {
        const segment = frame.slice(i * binPerBar, (i + 1) * binPerBar);
        let avg = segment.reduce((sum, val) => sum + val, 0) / segment.length;

        // å‘¨ã‚Šã¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹
        const localMax = Math.max(...segment);
        const localMin = Math.min(...segment);
        avg = (avg + localMax * 0.2 + localMin * 0.1) / 1.3;

        // ãƒ­ã‚°ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆ200è¶…ãˆãŸã‚‰ä¼¸ã³ã«ããï¼‰
        if (avg > 200) avg = 200 + Math.log(avg - 200 + 1) * 20;

        bars.push(Math.round(avg).toString().padStart(3, '0'));
      }
      return bars;
    }

    function drawBars(barCount) {
      animationId = requestAnimationFrame(() => drawBars(barCount));
      if (!analyser) return;
      analyser.getByteFrequencyData(dataArray);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const barWidth = canvas.width / barCount;
      for (let i = 0; i < barCount; i++) {
        const segment = dataArray.slice(i * (dataArray.length / barCount), (i + 1) * (dataArray.length / barCount));
        let height = segment.reduce((a, b) => a + b, 0) / segment.length;

        if (height > 200) height = 200 + Math.log(height - 200 + 1) * 20;

        ctx.fillStyle = `hsl(${i * 360 / barCount}, 100%, 50%)`;
        ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 1, height);
      }
    }

    function updateSDFText(barCount) {
      const letters = getLabel().slice(0, barCount);
      const lists = Array(barCount).fill().map(() => []);
      collectedData.forEach(frame => {
        for (let i = 0; i < barCount; i++) {
          lists[i].push(frame[i]);
        }
      });
      const sdf = lists.map((list, i) => `[${letters[i]}]:${list.join(",")}`).join("/");
      document.getElementById("sdfTextArea").value = sdf;
    }

    const listIdMap = {};
    getLabel().forEach((char, idx) => {
      listIdMap[char] = `id_${idx.toString().padStart(2, '0')}`;
    });

    function parseSDF(text) {
      const result = {};
      text.split("/").forEach(entry => {
        const match = entry.match(/\[([0-9a-zA-Z])\]:(.+)/);
        if (match) {
          const key = match[1];
          const values = match[2].split(",").map(x => x.trim().padStart(3, "0"));
          result[key] = values;
        }
      });
      return result;
    }

    document.getElementById("exportSpriteBtn").onclick = async () => {
      const sdfText = document.getElementById("sdfTextArea").value;
      const sdfData = parseSDF(sdfText);
      const response = await fetch("https://raw.githubusercontent.com/kikukick/kikukick_program_page/main/pages/.sprite3/ä¾‹.sprite3");
      const blob = await response.blob();
      const zip = await JSZip.loadAsync(blob);
      const spriteJson = JSON.parse(await zip.file("sprite.json").async("string"));

      for (const key in sdfData) {
        const id = listIdMap[key];
        if (spriteJson.lists && id in spriteJson.lists) {
          const listName = spriteJson.lists[id][0];
          spriteJson.lists[id] = [listName, sdfData[key]];
        }
      }

      zip.file("sprite.json", JSON.stringify(spriteJson, null, 2));
      const newBlob = await zip.generateAsync({ type: "blob" });

      const a = document.createElement("a");
      a.href = URL.createObjectURL(newBlob);
      a.download = "output_with_sdf.sprite3";
      a.click();
    };
  </script>
</body>
</html>
